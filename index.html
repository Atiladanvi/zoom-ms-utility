<!doctype html>
<html>
<head>
<meta charset="utf-8">
<script>
//
// Zoom MS-50G Utility
//
// MIDI commands
//  These commands are inferred by irresponsible experiment and not garanteed.
//
//  ProgramChange : [0xc0,pp]
//     Select patch by MIDI Program Change pp=patch number (0-49)
//  RequestCurrentProgram : [0xf0,0x52,0x00,0x58,0x33,0xf7]
//     Request current bank&program. It returns [0xb0,0x00,0x00, 0xb0,0x20,0x00, 0xc0,pp] pp=program#(0-49) bank is always 0
//  IdentityRequest : [0xf0,0x7e,0x00,0x06,0x01,0xf7]
//     Identity Request (MIDI Universal System Exclusive). It return [0xf0,0x7e,0x00,0x06,0x02,0x52,0x58,0x00,0x00,0x00,0x33,0x2e,0x30,0x30,0xf7]
//  TunerMode : [0xb0,0x4a,mm]
//     Tuner Mode On/Off. MIDI Control Change CC#74. mm<64:off mm>=64:on
//  EffectEnable : [0xf0,0x52,0x00,0x58,0x31,nn,0x00,mm,0x00,0xf7]
//     Effect On/Off. It seems effective only for effect1-3.  nn=effect#(0-2) mm=0:off mm=1:on
//  ParameterEditEnable : [0xf0,0x52,0x00,0x58,vv,0xf7]
//     Parameter value edit enable. Needed before Parameter Edit command.  vv=0x50:Disable vv=0x51:Enable
//  ParameterEdit : [0xf0,0x52,0x00,0x58,0x31,0x01,nn,vvLSB,vvMSB,0xf7]
//     Parameter value edit. nn=param#+2 vv=value. value range is depends on each effect.
//  WritePatch : [0xf0,0x52,0x00,0x58,0x28,effect1,effect2,...effect6,patch-name,0xf7] (146bytes)
//     Write 146bytes patch-data to current program.
//     It consist of [0xf8,0x52,0x00,0x58,0x28, effect1,effect2,...effect6, patch-name,0xf7]
//  RequestPatch : [0xf0,0x52,0x00,0x58,0x29,0xf7]
//     Requst patch-data of current program. it returns 146 bytes patch-data (same as WritePatch command)
//
//
var midiaccess=null;
var midioutputs=[];
var midiout=null;
var midirecv="";
var patches;
var patchindex=-1;
var currentpatch=-1;
var timer,timerprg;
var dragtarget=null;
var ready=false;

function MakeStr(b){
  var str="";
  for(var j=0;j<b.length;++j)
    str+=("00"+b[j].toString(16)).substr(-2);
  return str;
}
function MakeName(b){
  var name="";
  for(var j=0;j<13;++j){
    var c=b[132+j];
    if(c)
      name+=String.fromCharCode(c);
  }
  return name;
}
function MakeBin(s){
  var bin=[];
  for(var j=0;j<s.length;j+=2)
    bin.push(parseInt(s.substr(j,2),16));
  return bin;
}
function Init(){
  var i;
  if(!navigator.requestMIDIAccess){
    alert("This browser does not support Web MIDI API. Please use latest Chrome.");
    return;
  }
  navigator.requestMIDIAccess({sysex:true}).then(
    function(ma){
      var i=0,pt=0;
      midiaccess=ma;
      midiaccess.onstatechange=StateChange;
      var outputIterator=midiaccess.outputs.values();
      for(var o=outputIterator.next(); !o.done; o=outputIterator.next()) {
          midioutputs[i]=o.value;
          var op=new Option(o.value.name);
          if(o.value.name=="ZOOM MS Series")
            op.selected=true;
          document.getElementById("midiport").options[i]=op;
          i++;
      }
      SelectPort();
      if(!midiout)
        alert("MIDI port is not found.");
      var inputIterator=midiaccess.inputs.values();
      for(var ip=inputIterator.next(); !ip.done; ip=inputIterator.next()){
        if(ip.value.name==="ZOOM MS Series"){
          ip.value.addEventListener("midimessage",
            function(ev){
              midirecv=MakeStr(ev.data);
              console.log(midirecv);
              if(ev.data[0]==0xc0){
                console.log(ev.data[1]);
                DispPatch(0);
                currentpatch=ev.data[1];
                DispPatch(1);
              }
              if(midirecv.substr(0,10)=="f052005828"){
                var name=MakeName(ev.data);
                if(patchindex>=0){
                  patches[patchindex++]={name:name,data:ev.data};
                  if(patchindex>49){
                    SelectPatch(currentpatch);
                    patchindex=-1;
                  }
                  else{
                    midiout.send([0xc0,patchindex]);
                    midiout.send([0xf0,0x52,0,0x58,0x29,0xf7]);
                  }
                }
//                console.log("name:"+name);
              }
            }
          );
        }
      }
    },
    function(e){alert("requestMIDIAccess Error");},
  );
  document.addEventListener("keydown",function(ev){
    if(ready){
      var p;
      if(document.getElementById("renamepane").style.maxHeight=="500px")
        return;
      if(ev.keyCode>=48 && ev.keyCode<=57){
        if((p=ev.keyCode-49)<0)
          p=9;
        SelectPatch(p);
        ev.preventDefault();
      }
      if(ev.keyCode==37 || ev.keyCode==39){
        p=currentpatch;
        if(ev.keyCode==37){
          if(--p<0)
            p=49;
        }
        else{
          if(++p>=50)
            p=0;
        }
        SelectPatch(p);
        ev.preventDefault();
      }
    }
  });
}
function Scan(){
  if(!midiout || midiout.name!="ZOOM MS Series"){
    alert("ZOOM MS Series is not found.");
    return;
  }
  midiout.send([0xf0,0x52,0x00,0x58,0x33,0xf7]);
  if(timerprg)
    clearInterval(timerprg);
  setTimeout(function(){
    Edit(1);
    setTimeout(function(){
      DumpPatches();
      timer=setInterval(function(){
        if(patchindex<0){
          clearInterval(timer);
          for(i=0;i<50;++i){
            var cell=GetCell(i);
            cell.innerHTML=(i+1)+":"+patches[i].name;
            cell.id=i;
            cell.onmousedown=function(ev){
              document.getElementById("popupmenu").style.display="none";
              SelectPatch(ev.target.id);
              if(dragtarget){
                dragtarget.style.background="#ccf";
                dragtarget.style.color="#000";
              }
            };
            cell.draggable=true;
            cell.ondragstart=function(ev){
              if(dragtarget){
                dragtarget.style.background="#ccf";
                dragtarget.style.color="#000";
              }
              ev.dataTransfer.setData("text",ev.target.id);
            };
            cell.ondragenter=function(ev){
              if(ev.target.id!=currentpatch){
                ev.target.style.background="#aaf";
                ev.target.style.color="#000";
                dragtarget=ev.target;
              }
            };
            cell.ondragleave=function(ev){
              ev.target.style.background="#ccf";
              ev.target.style.color="#000";
            };
            cell.ondragover=function(ev){
              ev.preventDefault();
            };
            cell.ondrop=function(ev){
              var s=parseInt(event.dataTransfer.getData("text"));
              var d=parseInt(ev.target.id);
              if(s!=d)
                PopupMenu(ev.target);
              ev.preventDefault();
            };
            cell.ondragend=function(ev){
              var e=document.getElementById("popupmenu");
              if(e.style.display!="block")
                dragtarget.style.background="#ccf";
            };
          }
          document.getElementById("msg").innerHTML="Ready";
          document.getElementById("renamebtn").disabled=false;
          document.getElementById("savebtn").disabled=false;
          document.getElementById("loadbtn").disabled=false;
          ready=true;
          if(timerprg)
            clearInterval(timerprg);
          timerprg=setInterval(function(){
            midiout.send([0xf0,0x52,0x00,0x58,0x33,0xf7]);
          },200);
        }
        else{
          document.getElementById("msg").innerHTML="Scanning("+patchindex+")...";
        }
      },200);
    },200);
  },200);
}
function StateChange(){
  console.log("StateChange");
}
function PopupMenu(tar){
  tar.style.background="#aaf";
  var rc=tar.getBoundingClientRect();
  var e=document.getElementById("popupmenu");
  e.style.display="block";
  e.style.left=(rc.left+20)+"px";
  e.style.top=(rc.top+20)+"px";
}
function PopupCancel(){
  var e=document.getElementById("popupmenu");
  e.style.display="none";
  dragtarget.style.background="#ccf";
  dragtarget.style.color="#000";
}
function PopupCopy(){
  var e=document.getElementById("popupmenu");
  e.style.display="none";
  Copy(currentpatch,dragtarget.id);
  SelectPatch(dragtarget.id);
  SendPatch(dragtarget.id);
}
function GetCell(p){
  if(p<0)
    return null;
  var t=document.getElementById("table");
  return t.rows[p%10].cells[(p/10)|0];
}
function SelectPort(){
  if(midioutputs.length>0)
    midiout=midioutputs[document.getElementById("midiport").selectedIndex];
}
function SelectPatch(p){
  p=parseInt(p);
  if(p<0)
    return;
  DispPatch(0);
  if(midiout)
    midiout.send([0xc0,p]);
  currentpatch=p;
  DispPatch(1);
}
function DispPatch(f){
  if(currentpatch<0)
    return;
  c=GetCell(currentpatch);
  if(f){
    c.style.background="#f00";
    c.style.color="#fff";
  }
  else{
    c.style.background="#ccf";
    c.style.color="#004";
  }
}
function SendPatch(p){
  p=parseInt(p);
  if(midiout)
    midiout.send(patches[p].data);
}
function DumpPatches(){
  if(!midiout)
    return;
  midiout.send([0xc0,0]);
  patches=[];
  patchindex=0;
  midiout.send([0xf0,0x52,0,0x58,0x29,0xf7]);
}
function Edit(p){
  if(!midiout)
    return;
  if(p)
    midiout.send([0xf0,0x52,0x00,0x58,0x50,0xf7]);
  else
    midiout.send([0xf0,0x52,0x00,0x58,0x51,0xf7]);
}
function Usage(){
  var e=document.getElementById("usage");
  if(e.style.maxHeight!="500px"){
    e.style.maxHeight="500px";
    e.style.border="1px solid #000";
    e.style.padding="10px";
  }
  else{
    e.style.maxHeight="0px";
    e.style.border="0px solid #000";
    e.style.padding="0px";
  }
}
function Save(){
  var p=currentpatch;
  if(p<0)
    return;
  var n=patches[p].name;
  var fname=n.replace(/\s+$/,"").replace(/ /g,"_");
  var d=MakeStr(patches[p].data);
  var blob=new Blob([d],{"type":"text/plain"});
  var a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.target="_blank";
  a.download=fname+".txt";
  a.click();
  console.log(n,d,fname);
}
function Load(){
  var p=currentpatch;
  if(p<0)
    return;
  var i=document.createElement("input");
  i.type="file";
  i.click();
  i.addEventListener("change",function(ev){
    var file=ev.target.files;
    var reader=new FileReader();
    reader.readAsText(file[0]);
    reader.onload=function(ev){
      console.log(reader.result);
      patches[p].data=MakeBin(reader.result);
      patches[p].name=MakeName(patches[p].data);
      GetCell(p).innerHTML=(p+1)+":"+patches[p].name;
      SelectPatch(p);
      SendPatch(p);
    }
  },false);
}
function Copy(s,d){
  s=parseInt(s); d=parseInt(d);
  patches[d].data=patches[s].data.slice(0);
  patches[d].name=MakeName(patches[d].data);
  GetCell(d).innerHTML=(d+1)+":"+patches[d].name;
}
function Rename(){
  var p=currentpatch;
  if(p<0)
    return;
  var el=document.getElementById("renamepane");
  document.getElementById("newname").value=patches[currentpatch].name;
  if(el.style.maxHeight!="500px"){
    el.style.maxHeight="500px";
    el.style.padding="10px";
  }
  else
    CancelRename();
}
function CancelRename(){
  var el=document.getElementById("renamepane");
  el.style.maxHeight="0px";
  el.style.padding="0px 10px";
}
function OkRename(){
  var i;
  var name=document.getElementById("newname").value;
  var p=currentpatch;
  if(name.length>10)
    name=name.substr(0,10);
  patches[p].name=name;
  patches[p].data[132]=name.charCodeAt(0);
  for(i=1;i<=7;++i)
    patches[p].data[133+i]=name.charCodeAt(i);
  for(i=8;i<=9;++i)
    patches[p].data[134+i]=name.charCodeAt(i);
  GetCell(p).innerHTML=(p+1)+":"+patches[p].name;
  SelectPatch(p);
  SendPatch(p);
  CancelRename();
}
window.addEventListener("load",Init);

</script>
<style>
body{
  background:#348;
  margin:0px;
  padding:0px;
}
#base{
  position:relative;
  width:800px;
  margin:0px auto;
  padding:1px 20px 40px 20px;
  background:#fff;
  font-size:14px;
}
#header{
  background:#036;
  color:#ddf;
  margin:0px;
  width:100%;
  height:90px;
}
#popupmenu{
  position: absolute;
  display:none;
  width:100px;
  background:#fff;
  border: 1px solid #000;
  list-style: none;
  font-size:14px;
  margin:0;
  padding:0;
}
#popupmenu>li{
  background:#fff;
  text-decoration: none;
  margin:0;
  padding:0;
}
#popupmenu>li>a{
  display:block;
  text-decoration: none;
  padding:0px 20px;
}
#popupmenu>li:hover{
  background:#adf;
  color:#fff;
}
.popupmenuitem{
}
.popupmenuitem :hover{
}
img{
  margin:0px;
  padding:0px;
}
#rename {
  display:none;
}
.patch{
  background: #66f;
  border:1px solid #225;
  border-radius: 5px;
  width:220px;
  height:60px;
}
#renamepane {
  background:#66f;
  color:#fff;
  border:1px solid #000;
  padding: 0px 10px;
  border:0px solid #000;
  max-height:0px;
  overflow:hidden;
  transition:.5s;
}
#usage{
  max-height:0px;
  border:0px solid #000;
  background:#ccf;
  margin:5px;
  transition:0.5s;
  overflow:hidden;
  padding:0px;
}
button{
  width:120px;
  height:30px;
}
button[disabled]{
  color:#aaa;
}
table{
  border:1px solid #000;
  margin:0;
  padding:0;
}
tr{
  margin:0;
  padding:0;
}
td{
  border:1px solid #000;
  margin:0;
  padding:0px 0px 0px 5px;
  width:160px;
  height:30px;
  cursor:pointer;
  background:#ccf;
}
</style>
</head>
<body>
  <div id="base">
    <div id="header">
      <a href="http://www.g200kg.com/"><img src="./g200kg160x80.png" style="float:left;margin:4px 11px"/></a>
      <h1>Zoom MS-50G Utility</h1>
    </div>
    <hr style="clear:both"/>
    <p> This is a patch utility for ZOOM MS-50G MultiStomp guitar pedal.</p>
  <hr/>
  MidiPort : <select id="midiport" onchange="SelectPort()"></select><br/><br/>
  <button id="scanbtn" onclick="Scan()">Scan MS-50G</button>
  <button id="renamebtn" onclick="Rename()" disabled=true>Rename</button>
  <button id="savebtn" onclick="Save()" disabled=true>Save To File</button>
  <button id="loadbtn" onclick="Load()" disabled=true>Load From File</button>
  <button id="usagebtn" onclick="Usage()">How To Use</button>
  <div id="renamepane">
    New name : <input id="newname"/><br/><br/><button onclick="CancelRename()">Cancel</button><button onclick="OkRename()">OK</button>
  </div>
  <div id="usage">
    <h3>Usage</h3>
    <p>
      This is still a very tentative version for the confirmation of MIDI related fucntion.<br/>
      If you are interested in MS-50G MIDI related function, check GitHub repository<br/>
      <a href="https://github.com/g200kg/zoom-ms-utility">GitHub repository</a>
    </p>
    <ul>
      <li>Connect PC/Mac to MS-50G via USB</li>
      <li>Launch this page. You should use Latest Chrome. On Windows, unplugging the USB while running may cause freeze (under investigation). Once close all Chrome window if you have MidiPort detection problem.</li>
      <li>Press accept if 'MIDI device' permission dialog is displayed  (press keyboard icon on right edge of address bar and retry if you make a mistake)</li>
      <li>Select MidiPort to 'ZOOM MS Series'</li>
      <li>Press 'Scan MS-50G'</li>
      <li>After scan, select patch by click and use buttons 'Rename', 'SaveToFile' or 'LoadFromFile'</li>
      <li>Each patch can be drag and drop to another position. It will overwrite old patch.</li>
      <li>Keyboard Left/Right is assigned to patch Down/Up, '1'-'9' and '0' is assigned to select patch '1' to '10'. </li>
      <li>If you want to choose save directory when 'SaveToFile', I recommend change Chrome setting of setting-detail-download confirm folder</li>
    </ul>
    <button onclick="Usage()">close</button>
  </div>
  <hr/>
  Status : <span id="msg">Not Initialized</span><br/>
  <br/>
<table id="table">
  <tr><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><td></td><td></td><td></td><td></td><td></td></tr>
</table>
  <hr/>
</div>
<ul id="popupmenu">
  <li><a href="#" onclick="PopupCopy()">Copy</a></li>
  <li><a href="#" onclick="PopupCancel()">Cancel</a></li>
</ul>
</body>
</html>
